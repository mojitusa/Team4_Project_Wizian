<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<title>중앙 - 상담 시스템</title>

<!-- CSS File -->
<link href="assets/css/main.css" rel="stylesheet">
<link href="assets/css/disability.css" rel="stylesheet">
<!-- Bootstrap CSS -->
<link
	href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
	rel="stylesheet">
<style>
#counselingOptions {
	margin-top: 20px;
	margin-bottom: 10px;
	width: 50%;
	font-size: 16px;
}

.tui-grid-cell {
	font-size: 14px; /* 원하는 폰트 크기로 조정 */
	color: #333; /* 원하는 색상으로 조정 */
	text-align: center;
}

.custom-btn {
	padding: 1px 4px;
	font-size: 14px;
}

.custom-btn-container {
	display: flex;
	justify-content: center;
	align-items: center;
}
</style>
</head>
<body class="index-page">
	<main class="myCounLog">
		<section id="myCounLog">
			<div class="container">
				<h2>나의 상담 내역</h2>
				<img id="myImg" src="/image/마이페이지1.jpg">
				<div class="guide_wrap">
					<ul>
						<li class="first">예약대기 상태에서는 언제든지 상담을 취소할 수 있습니다.</li>
						<li class="last">예약이 승인된 상담을 부득이하게 취소해야 할 경우, 상담자에게 따로 연락하여
							취소요청하시길 바랍니다.</li>
					</ul>
				</div>
				<div class="mb-3 d-flex align-items-center">
					<span class="me-3" style="font-weight: bold;">상담 종류 선택 :</span> <select
						id="counselingOptions" class="form-select"
						style="margin-top: 7px;">
						<option value="1">취업상담</option>
						<option value="2">성평등상담</option>
						<option value="3">장애상담</option>
						<option value="4">심리상담</option>
						<option value="5">지도교수</option>
						<option value="6">집단상담</option>
					</select>
				</div>
				<div id="grid2"></div>
			</div>
		</section>
	</main>

	<!-- Modal -->
	<div class="modal fade" id="customModal" tabindex="-1" role="dialog"
		aria-labelledby="customModalLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="customModalLabel">상세보기</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<!-- 모달 내용 -->
					<p id="modalContent">모달 내용</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">닫기</button>
				</div>
			</div>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/tui-grid@4.19.0/dist/tui-grid.min.js"></script>
	<script
		src="https://cdn.jsdelivr.net/npm/tui-grid@4.19.0/dist/tui-grid.min.css"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<script type="text/javascript">
var grid2; // 전역 변수로 선언

$(document).ready(function () {
    var userNo = [[${session.userNo}]]; // 사용자 번호를 실제 값으로 설정
    initializeCounLog(userNo);

    $('#counselingOptions').change(function() {
        var selectedOption = $(this).val();
        fetchCounselingData(selectedOption, userNo);
    });

    $('#grid').hide();
    $('#grid2').show();
});

function initializeCounLog(userNo) {
    var selectedOption = $('#counselingOptions').val();
    
    grid2 = new tui.Grid({
        el: document.getElementById('grid2'),
        pageOptions: {
            useClient: true,
            perPage: 10
        },
        scrollX: false,
        scrollY: false,
        columns: [{
            header: '번호',
            name: 'CSL_NO',
            width: 110,
            align: 'center',
            	sortable: true
        }, {
            header: '신청일',
            name: 'CSL_DATE',
            width: 210,
            align: 'center',
            sortable: true
        }, {
            header: '상담종류',
            width: 260,
            name: 'CSL_CATEGORY',
            align: 'center',
        }, {
            header: '상태',
            width: 150,
            name: 'CSL_STATUS',
            align: 'center',
            sortable: true
        }, {
            header: '상세보기',
            width: 160,
            align: 'center',
            renderer: {
                type: CustomButtonRenderer,
                options: {
                    text: '조회하기',
                    onClick: function(ev) {
                        $('#modalContent').text('상세보기 클릭: ' + ev.rowKey);
                        $('#customModal').modal('show');
                    },
                    className: 'btn btn-primary custom-btn'
                }
            }
        }, {
            header: '예약취소',
            width: 200,
            align: 'center',
            renderer: {
                type: CustomButtonRenderer,
                options: {
                    text: '예약취소',
                    onClick: function(ev) {
                        $('#modalContent').text('예약취소 클릭: ' + ev.rowKey);
                        $('#customModal').modal('show');
                    },
                    className: 'btn btn-primary custom-btn'
                }
            }
        }]
    });
    fetchCounselingData(selectedOption, userNo);
}

function fetchCounselingData(option, userNo) {
    $.ajax({
        url: "/counselHistory/json",
        type: "get",
        data: { category: option, userNo: userNo },
        dataType: "json",
        contentType: "application/json; charset=UTF-8",
        success: function (result) {
            console.log("Success:", result);
            var counselHistory = result.counselHistory;
            if (!Array.isArray(counselHistory)) {
                console.error("Unexpected data format:", counselHistory);
                return;
            }
            counselHistory.forEach((item, index) => {
                item.CSL_NO = index + 1; // 자동 인덱스 부여
            });
            grid2.resetData(counselHistory);
            grid2.refreshLayout();
        },
        error: function (xhr, status, error) {
            console.error('Error fetching counsel history data:', status, error);
            console.log('Response:', xhr.responseText);
            if (xhr.responseText) {
                try {
                    const jsonResponse = JSON.parse(xhr.responseText);
                    console.log('Parsed JSON:', jsonResponse);
                } catch (e) {
                    console.error('Failed to parse JSON response:', e);
                }
            }
        }
    });
}

function CustomButtonRenderer(props) {
    const container = document.createElement('div');
    container.className = 'custom-btn-container'; // Add class for flex container
    const button = document.createElement('button');
    button.textContent = props.columnInfo.renderer.options.text;
    button.className = props.columnInfo.renderer.options.className;
    button.addEventListener('click', () => {
        props.columnInfo.renderer.options.onClick(props);
    });
    container.appendChild(button);
    this.el = container; // Set container as element
}

CustomButtonRenderer.prototype.getElement = function() {
    return this.el;
}
</script>

</body>
</html>
