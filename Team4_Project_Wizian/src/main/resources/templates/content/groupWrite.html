<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>중앙 - 상담 시스템</title>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.js"></script>
    <!-- jQuery UI -->
    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
    <!-- SweetAlert -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.js"></script>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <!-- Tempus Dominus Bootstrap 4 datetimepicker CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet">
    <!-- Tempus Dominus Bootstrap 4 datetimepicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tempusdominus-bootstrap-4/5.39.0/js/tempusdominus-bootstrap-4.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.3.5/jquery.timepicker.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.3.5/jquery.timepicker.min.js"></script>
    <!-- Main CSS File -->
    <link href="assets/css/main.css" rel="stylesheet">
    <link href="assets/css/group.css" rel="stylesheet">
</head>

<body class="index-page">
    <header class="header">
        <div th:replace="~{../templates/fragments/header}"></div>
    </header>

    <main class="groupBox">
        <section id="groupWriteSection">
            <div class="gcpage3">
                <div class="gcpa">상담 등록</div>
                <br>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">프로그램 이름</div>
                    <div class="gcgroupRegisterInput1">
                        <input type="text" name="PRGRM_NM" required placeholder="프로그램 이름을 입력하세요.">
                    </div>
                    <div class="nameBox2">정원</div>
                    <div class="gcgroupRegisterInput3">
                        <input type="number" name="NOPE" required placeholder="정원을 입력하세요.">
                    </div>
                </div>
                <br>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">모집시작일정</div>
                    <div class="gcgroupRegisterInput2">
                        <input type="text" id="SCHDL_BGNG_YMD" name="SCHDL_BGNG_YMD" required placeholder="모집시작 날짜를 입력하세요.">
                    </div>
                    <div class="nameBox2">모집끝일정</div>
                    <div class="gcgroupRegisterInput3">
                        <input type="text" id="SCHDL_END_YMD" name="SCHDL_END_YMD" required placeholder="모집끝 날짜를 입력하세요.">
                    </div>
                </div>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">집단상담 날짜</div>
                    <div class="gcgroupRegisterInput2">
                        <input type="text" id="GC_DT_DATE" name="GC_DT_DATE" required placeholder="상담 날짜를 입력하세요.">
                    </div>
                    <div class="nameBox1">집단상담 시간</div>
                    <div class="gcgroupRegisterInput2">
                        <input type="text" id="GC_DT_TIME" name="GC_DT_TIME" required placeholder="상담 시간을 입력하세요.">
                    </div>
                </div>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">집단상담 유형</div>
                    <div class="gcgroupRegisterInput2">
                        <input type="text" name="PRGRM_TYPE" required placeholder="프로그램 유형을 입력하세요.">
                    </div>
                    <div class="nameBox2">주최기관명</div>
                    <div class="gcgroupRegisterInput3">
                        <input type="text" name="GC_OG_NM" required placeholder="주최기관 이름을 입력하세요.">
                    </div>
                </div>
                <br>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">집단상담 개요</div>
                    <div class="gcgroupRegisterInput4">
                        <textarea name="counselingContent" required placeholder="프로그램에 대한 설명을 입력하세요."></textarea>
                    </div>
                    <input type="hidden" name="encodedCounselingContent">
                </div>
                <div class="submit-button">
                    <button id="validate-button" type="button" style="margin-left: 10px; width: 100px; height: 40px;">양식검사</button>
                    <button id="submit-button" type="submit" style="margin-left: 10px; width: 100px; height: 40px; display:none;" disabled>등록하기</button>
                </div>
                <div class="gcgroupRegisterBox1">
                    <div class="nameBox1">집단상담 포스터</div>
                    <div class="gcgroupRegisterInput4">
                        <form id="poster-form" enctype="multipart/form-data">
                            <div class="input-group mb-3">
                                <input type="file" accept="image/*" id="file1" name="file1" class="form-control">
                            </div>
                        </form>
                    </div>
                </div>
                <br><br>
                <div style="display: flex; justify-content: space-between;">
                    <div>
                        <a th:href="@{./group }">
                            <button id="cancelBtn" style="margin-left: 10px; width: 100px; height: 40px;">취 소</button>
                        </a>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        $(document).ready(function() {
            // Datepicker 설정
            $("#SCHDL_BGNG_YMD, #SCHDL_END_YMD, #GC_DT_DATE").datepicker({
                dateFormat: "yy_mm_dd" // 날짜 형식 설정
            });

            $('#GC_DT_TIME').timepicker({
                format: 'HH:mm', // 시간 형식 설정
                showMeridian: false // am/pm 표기 숨기기
            });

            // 유효성 검사 함수 정의
            function encodeHTML(text) {
                return text.replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;')
                    .replace(/\n/g, '<br/>')
                    .replace(/ /g, '&nbsp;');
            }

            function validateForm() {
                var isValid = true;

                // 입력값 가져오기
                var GC_DT_DATE = $('#GC_DT_DATE').val(); // GC_DT_DATE 입력 필드에서 날짜 값을 가져옴
                var GC_DT_TIME = $('#GC_DT_TIME').val(); // GC_DT_TIME 입력 필드에서 시간 값을 가져옴
                // 날짜와 시간을 연결하여 GC_DT 생성
                var GC_DT = GC_DT_DATE + ' ' + GC_DT_TIME;

                var PRGRM_NM = $('input[name="PRGRM_NM"]').val();
                var SCHDL_BGNG_YMD = $('input[name="SCHDL_BGNG_YMD"]').val();
                var SCHDL_END_YMD = $('input[name="SCHDL_END_YMD"]').val();
                var NOPE = $('input[name="NOPE"]').val();
                var PRGRM_TYPE = $('input[name="PRGRM_TYPE"]').val();
                var GC_OG_NM = $('input[name="GC_OG_NM"]').val();
                var encodedContent = $('textarea[name="counselingContent"]').val();
                var counselingContent = encodeHTML(encodedContent);

                function validateDate(dateString) {
                    var regex = /^\d{4}_\d{2}_\d{2}$/; // YYYY_MM_DD 형식 검사
                    return regex.test(dateString);
                }

                // 유효성 검사
                if (!PRGRM_NM || !SCHDL_BGNG_YMD || !SCHDL_END_YMD || !NOPE || !PRGRM_TYPE || !GC_OG_NM || !counselingContent) {
                    isValid = false;
                }
                if (!validateDate(SCHDL_BGNG_YMD) || !validateDate(SCHDL_END_YMD) || !validateDate(GC_DT_DATE)) {
                    isValid = false;
                }

                // 업로드 파일 존재 여부 확인
                var fileInput = $('#file1'); // 파일 입력 필드 가져오기
                
                if (!fileInput.val()) {
                    fileInput.focus();
                    return;
                }

                const files = fileInput[0].files;

                if (files.length > 0) {
                    const validExtensions = ['jpg', 'jpeg', 'png', 'gif', 'bmp'];
                    const fileExtension = files[0].name.split('.').pop().toLowerCase();

                    if (!validExtensions.includes(fileExtension)) {
                        fileInput.focus();
                        return;
                    }
                }

                const formData = new FormData();

                // 여기에 파일을 formData에 추가하는 코드 추가

                return isValid;
            }

            // 유효성 검사 버튼 클릭 이벤트 핸들러
            $('#validate-button').click(function() {
                if (validateForm()) {
                    Swal.fire({
                        icon: 'success',
                        title: '유효성 검사 성공',
                        text: '유효성 검사를 통과했습니다.',
                    });
                    $('#submit-button').prop('disabled', false).show();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: '유효성 검사 실패',
                        text: '모든 필드를 올바르게 입력해주세요.',
                    });
                }
            });

            // 양식 필드 변경 이벤트 핸들러
            $('input, textarea').on('input change', function() {
                $('#submit-button').prop('disabled', true).hide();
            });

            // 등록 버튼 클릭 이벤트 핸들러
            $('#submit-button').click(function() {
                // 양식 데이터를 가져오기
                var formData = new FormData();
                formData.append("PRGRM_NM", $('input[name="PRGRM_NM"]').val());
                formData.append("SCHDL_BGNG_YMD", $('input[name="SCHDL_BGNG_YMD"]').val());
                formData.append("SCHDL_END_YMD", $('input[name="SCHDL_END_YMD"]').val());
                formData.append("NOPE", $('input[name="NOPE"]').val());
                formData.append("GC_DT", $('#GC_DT_DATE').val() + ' ' + $('#GC_DT_TIME').val());
                formData.append("PRGRM_TYPE", $('input[name="PRGRM_TYPE"]').val());
                formData.append("GC_OG_NM", $('input[name="GC_OG_NM"]').val());
                formData.append("counselingContent", $('textarea[name="counselingContent"]').val());

                // 파일 데이터를 가져오기
                var fileInput = document.getElementById('file1');
                if (fileInput.files.length > 0) {
                    formData.append("file1", fileInput.files[0]);
                }

                // AJAX 요청
                $.ajax({
                    type: 'POST',
                    url: '/groupWrite',
                    data: formData,
                    processData: false, // jQuery가 데이터를 처리하지 않도록 설정
                    contentType: false, // jQuery가 Content-Type 헤더를 설정하지 않도록 설정
                    success: function(response) {
                        Swal.fire({
                            icon: 'success',
                            title: '등록 성공',
                            text: '상담 등록이 성공적으로 완료되었습니다.',
                        }).then(function() {
                            window.location.href = '/group'; // 등록 후 리디렉션할 URL을 입력하세요
                        });
                    },
                    error: function(xhr, status, error) {
                        Swal.fire({
                            icon: 'error',
                            title: '등록 실패',
                            text: '상담 등록 중 오류가 발생했습니다.',
                        });
                    }
                });
            });
        });
    </script>
</body>

</html>